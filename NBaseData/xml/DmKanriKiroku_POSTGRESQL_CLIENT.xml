<?xml version="1.0" encoding="utf-8" ?>

<databaseConfig>

	<sql name="GetRecords">
		SELECT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID        ,
		DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID               ,
		DM_KANRI_KIROKU.STATUS           ,
		DM_KANRI_KIROKU.JIKI_NEN                     ,
		DM_KANRI_KIROKU.JIKI_TUKI                     ,
		DM_KANRI_KIROKU.ISSUE_DATE                    ,
		DM_KANRI_KIROKU.FILE_NAME                     ,
		DM_KANRI_KIROKU.FILE_UPDATE_DATE              ,
		DM_KANRI_KIROKU.BIKOU                         ,

		DM_KANRI_KIROKU.DELETE_FLAG                   ,
		DM_KANRI_KIROKU.SEND_FLAG                     ,
		DM_KANRI_KIROKU.VESSEL_ID                     ,
		DM_KANRI_KIROKU.DATA_NO                       ,
		DM_KANRI_KIROKU.USER_KEY                      ,
		DM_KANRI_KIROKU.RENEW_DATE                    ,
		DM_KANRI_KIROKU.RENEW_USER_ID                 ,
		DM_KANRI_KIROKU.TS                            ,
		MS_DM_BUNRUI.NAME AS MS_DM_BUNRUI_NAME         ,
		MS_DM_SHOUBUNRUI.NAME AS MS_DM_SHOUBUNRUI_NAME ,
		MS_DM_HOUKOKUSHO.BUNSHO_NO AS MS_DM_HOUKOKUSHO_BUNSHO_NO ,
		MS_DM_HOUKOKUSHO.BUNSHO_NAME AS MS_DM_HOUKOKUSHO_BUNSHO_NAME

		FROM
		DM_KANRI_KIROKU
		INNER JOIN MS_DM_HOUKOKUSHO ON MS_DM_HOUKOKUSHO.MS_DM_HOUKOKUSHO_ID = DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID
		INNER JOIN MS_DM_BUNRUI ON MS_DM_BUNRUI.MS_DM_BUNRUI_ID = MS_DM_HOUKOKUSHO.MS_DM_BUNRUI_ID
		LEFT JOIN MS_DM_SHOUBUNRUI ON MS_DM_SHOUBUNRUI.MS_DM_SHOUBUNRUI_ID = MS_DM_HOUKOKUSHO.MS_DM_SHOUBUNRUI_ID

		WHERE (DM_KANRI_KIROKU.DELETE_FLAG = 0 or DM_KANRI_KIROKU.DELETE_FLAG is NULL)
	</sql>

	<sql name="ByMsDmBunruiID">
		AND MS_DM_BUNRUI.MS_DM_BUNRUI_ID = :MS_DM_BUNRUI_ID
	</sql>

	<sql name="ByMsDmShoubunruiID">
		AND MS_DM_SHOUBUNRUI.MS_DM_SHOUBUNRUI_ID = :MS_DM_SHOUBUNRUI_ID
	</sql>

	<sql name="LikeBunshoNo">
		AND MS_DM_HOUKOKUSHO.BUNSHO_NO LIKE :BUNSHO_NO
	</sql>

	<sql name="LikeBunshoName">
		AND MS_DM_HOUKOKUSHO.BUNSHO_NAME LIKE :BUNSHO_NAME
	</sql>

	<sql name="ByDmKanriKirokuID">
		AND DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID like :DM_KANRI_KIROKU_ID
	</sql>

	<sql name="OrderBy">
		ORDER BY
		MS_DM_BUNRUI.CODE,
		MS_DM_BUNRUI.NAME,
		MS_DM_SHOUBUNRUI.CODE,
		MS_DM_SHOUBUNRUI.NAME,
		MS_DM_HOUKOKUSHO.BUNSHO_NO,
		MS_DM_HOUKOKUSHO.BUNSHO_NAME
	</sql>
	
	
  <sql name="InsertRecord">
	  INSERT INTO DM_KANRI_KIROKU
	  (
	  DM_KANRI_KIROKU_ID ,
	  MS_DM_HOUKOKUSHO_ID        ,
	  STATUS    ,
	  JIKI_NEN              ,
	  JIKI_TUKI            ,
	  ISSUE_DATE             ,
	  FILE_NAME              ,
	  FILE_UPDATE_DATE       ,
	  BIKOU                  ,

	  DELETE_FLAG     ,
	  SEND_FLAG       ,
	  VESSEL_ID       ,
	  DATA_NO         ,
	  USER_KEY        ,
	  RENEW_DATE      ,
	  RENEW_USER_ID   ,
	  TS
	  )
	  VALUES(
	  :DM_KANRI_KIROKU_ID ,
	  :MS_DM_HOUKOKUSHO_ID        ,
	  :STATUS    ,
	  :JIKI_NEN              ,
	  :JIKI_TUKI            ,
	  :ISSUE_DATE             ,
	  :FILE_NAME              ,
	  :FILE_UPDATE_DATE       ,
	  :BIKOU                  ,
	  :DELETE_FLAG     , 
	  :SEND_FLAG       ,
	  :VESSEL_ID       ,
	  :DATA_NO         ,
	  :USER_KEY        ,
	  :RENEW_DATE      ,
	  :RENEW_USER_ID   ,
	  :TS
	  )
  </sql>

  <sql name="UpdateRecord">
	  UPDATE DM_KANRI_KIROKU SET
	  MS_DM_HOUKOKUSHO_ID = :MS_DM_HOUKOKUSHO_ID         ,
	  STATUS = :STATUS ,
	  JIKI_NEN = :JIKI_NEN                     ,
	  JIKI_TUKI = :JIKI_TUKI                 ,
	  ISSUE_DATE = :ISSUE_DATE                   ,
	  FILE_NAME = :FILE_NAME                     ,
	  FILE_UPDATE_DATE = :FILE_UPDATE_DATE       ,
	  BIKOU = :BIKOU                             ,
	  DELETE_FLAG = :DELETE_FLAG      ,
	  SEND_FLAG = :SEND_FLAG          ,
	  VESSEL_ID = :VESSEL_ID          ,
	  DATA_NO = :DATA_NO              ,
	  USER_KEY = :USER_KEY            ,
	  RENEW_DATE = :RENEW_DATE        ,
	  RENEW_USER_ID = :RENEW_USER_ID  ,
	  TS = :TS

	  WHERE
	  DM_KANRI_KIROKU_ID = :DM_KANRI_KIROKU_ID
  </sql>




	<sql name="GetLatestRecord">
		SELECT *
		FROM
		(
		SELECT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID  ,
		DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID ,
		DM_KANRI_KIROKU.ISSUE_DATE,
		ROW_NUMBER() OVER (ORDER BY DM_KANRI_KIROKU.ISSUE_DATE DESC) AS LINE
		from
		DM_KANRI_KIROKU
		INNER JOIN DM_PUBLISHER ON DM_PUBLISHER.LINK_SAKI_ID = DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID
		AND DM_PUBLISHER.LINK_SAKI = :LINK_SAKI
		AND DM_PUBLISHER.KOUKAI_SAKI = :KOUKAI_SAKI
		INNER JOIN MS_USER_BUMON ON MS_USER_BUMON.MS_BUMON_ID = DM_PUBLISHER.MS_BUMON_ID
		AND MS_USER_BUMON.MS_USER_ID = :MS_USER_ID

		WHERE (DM_KANRI_KIROKU.DELETE_FLAG = 0 or DM_KANRI_KIROKU.DELETE_FLAG is NULL)
		AND DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID = :MS_DM_HOUKOKUSHO_ID
		)
		WHERE LINE &lt;= 1	
	</sql>
	
	<sql name="GetHonsenLatestRecord">
		SELECT
		DM_KANRI_KIROKU_ID,
		MS_DM_HOUKOKUSHO_ID,
		ISSUE_DATE
		FROM ( SELECT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID  ,
		DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID ,
		DM_KANRI_KIROKU.ISSUE_DATE
		from
		DM_KANRI_KIROKU
		INNER JOIN DM_PUBLISHER ON DM_PUBLISHER.LINK_SAKI_ID = DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID
		AND DM_PUBLISHER.LINK_SAKI = :LINK_SAKI
		AND DM_PUBLISHER.KOUKAI_SAKI = :KOUKAI_SAKI
		AND DM_PUBLISHER.MS_VESSEL_ID = :MS_VESSEL_ID

		WHERE (DM_KANRI_KIROKU.DELETE_FLAG = 0 or DM_KANRI_KIROKU.DELETE_FLAG is NULL)
		AND DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID = :MS_DM_HOUKOKUSHO_ID
		) AS TBL
		ORDER BY ISSUE_DATE DESC
    offset 0 limit 1
	</sql>

	<sql name="GetPastRecords">
		SELECT DISTINCT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID  ,
		DM_KANRI_KIROKU.STATUS,
		DM_KANRI_KIROKU.ISSUE_DATE,
		DM_KANRI_KIROKU.FILE_NAME,
		DM_KANRI_KIROKU.BIKOU,
		DM_KANRI_KIROKU.TS

		from
		DM_KANRI_KIROKU
		INNER JOIN DM_PUBLISHER ON DM_PUBLISHER.LINK_SAKI_ID = DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID
		AND DM_PUBLISHER.LINK_SAKI = :LINK_SAKI
		AND DM_PUBLISHER.KOUKAI_SAKI = :KOUKAI_SAKI
		INNER JOIN MS_USER_BUMON ON MS_USER_BUMON.MS_BUMON_ID = DM_PUBLISHER.MS_BUMON_ID
		AND MS_USER_BUMON.MS_USER_ID = :MS_USER_ID

		WHERE (DM_KANRI_KIROKU.DELETE_FLAG = 0 or DM_KANRI_KIROKU.DELETE_FLAG is NULL)
		AND DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID = :MS_DM_HOUKOKUSHO_ID

		ORDER BY DM_KANRI_KIROKU.ISSUE_DATE DESC
	</sql>

	<sql name="GetHonsenPastRecords">
		SELECT DISTINCT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID  ,
		DM_KANRI_KIROKU.STATUS,
		DM_KANRI_KIROKU.ISSUE_DATE,
		DM_KANRI_KIROKU.FILE_NAME,
		DM_KANRI_KIROKU.BIKOU,
		DM_KANRI_KIROKU.TS

		from
		DM_KANRI_KIROKU
		INNER JOIN DM_PUBLISHER ON DM_PUBLISHER.LINK_SAKI_ID = DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID
		AND DM_PUBLISHER.LINK_SAKI = :LINK_SAKI
		AND DM_PUBLISHER.KOUKAI_SAKI = :KOUKAI_SAKI
		AND DM_PUBLISHER.MS_VESSEL_ID = :MS_VESSEL_ID

		WHERE (DM_KANRI_KIROKU.DELETE_FLAG = 0 or DM_KANRI_KIROKU.DELETE_FLAG is NULL)
		AND DM_KANRI_KIROKU.MS_DM_HOUKOKUSHO_ID = :MS_DM_HOUKOKUSHO_ID

		ORDER BY DM_KANRI_KIROKU.ISSUE_DATE DESC
	</sql>





	<sql name="GetTargetRecords">
		SELECT DISTINCT
		DM_KANRI_KIROKU_ID,
		FILE_UPDATE_DATE,
		DELETE_FLAG

		FROM
		(

		SELECT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID,
		DM_KANRI_KIROKU.FILE_UPDATE_DATE,
		DM_KANRI_KIROKU.DELETE_FLAG

		FROM
		DM_KANRI_KIROKU
		INNER JOIN DM_KOUKAI_SAKI ON DM_KOUKAI_SAKI.LINK_SAKI_ID = DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID
		AND DM_KOUKAI_SAKI.LINK_SAKI = :LINK_SAKI
		AND DM_KOUKAI_SAKI.KOUKAI_SAKI = :KOUKAI_SAKI
		AND DM_KOUKAI_SAKI.MS_VESSEL_ID = :MS_VESSEL_ID
		AND DM_KOUKAI_SAKI.DELETE_FLAG = 0

		UNION

		SELECT
		DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID,
		DM_KANRI_KIROKU.FILE_UPDATE_DATE,
		DM_KANRI_KIROKU.DELETE_FLAG

		FROM
		DM_KANRI_KIROKU
		INNER JOIN DM_PUBLISHER ON DM_PUBLISHER.LINK_SAKI_ID = DM_KANRI_KIROKU.DM_KANRI_KIROKU_ID
		AND DM_PUBLISHER.LINK_SAKI = :LINK_SAKI
		AND DM_PUBLISHER.KOUKAI_SAKI = :KOUKAI_SAKI
		AND DM_PUBLISHER.MS_VESSEL_ID = :MS_VESSEL_ID
		AND DM_PUBLISHER.DELETE_FLAG = 0

		) KK_TBL

		WHERE DELETE_FLAG = 0
	</sql>

	<sql name="AndFileNotFoundRecords">
		AND NOT EXISTS (SELECT * FROM DM_KANRI_KIROKU_FILE WHERE DM_KANRI_KIROKU_FILE.DM_KANRI_KIROKU_ID = KK_TBL.DM_KANRI_KIROKU_ID)
	</sql>

	<sql name="AndDataUpdateDateDiffRecords">
    AND NOT EXISTS
    (
    SELECT DM_KANRI_KIROKU_ID
    FROM
    (
    SELECT
    DM_KANRI_KIROKU_FILE.DM_KANRI_KIROKU_ID,
    DM_KANRI_KIROKU_FILE.UPDATE_DATE
    FROM
    DM_KANRI_KIROKU_FILE
    INNER JOIN
    (
    SELECT DM_KANRI_KIROKU_ID, MAX(RENEW_DATE) AS RENEW_DATE
    FROM DM_KANRI_KIROKU_FILE
    WHERE DELETE_FLAG = 0
    GROUP BY DM_KANRI_KIROKU_ID
    ) TBL
    ON TBL.DM_KANRI_KIROKU_ID = DM_KANRI_KIROKU_FILE.DM_KANRI_KIROKU_ID
    AND TBL.RENEW_DATE = DM_KANRI_KIROKU_FILE.RENEW_DATE
    ) TEMP_FILE
    WHERE TEMP_FILE.DM_KANRI_KIROKU_ID = KK_TBL.DM_KANRI_KIROKU_ID
    AND to_char(TEMP_FILE.UPDATE_DATE,'yyyy-mm-dd hh24:mi:ss') =  to_char(KK_TBL.FILE_UPDATE_DATE,'yyyy-mm-dd hh24:mi:ss')
    )
  </sql>

</databaseConfig>
